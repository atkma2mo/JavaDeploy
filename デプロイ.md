Welcome to the JavaDeploy wiki!  

# 制作中なので見ないでください（笑）

# JavaDeploy  


Jenkins CircleCIなどは使いません。学内Webサーバへのデプロイ手順を説明します。クラウドの話もでません。Docker Vagrantも使わない。古き良きサーバの構築をします。  

ローカルの環境はOpenjdk11 Spring boot Apache maven h2DB inteliJを使用  

http://www.nsrg.fml.org/notes/proj-2018/

## warファイルを作る  

※Windowsでは文字コードの問題で不具合が発生する場合があるため、CentOSでは生成可能を確認  


まずはIntelliJでwarファイルを生成します。  

IntelliJで実行可能なJavaEEアプリケーションのプロジェクトを開き、File -> Project Structureを開きます。  

左メニューのArtifactsを選択します。  

画面上部にある「＋」ボタンを選択して、Web Application: Archive -> For ‘web:war exploded’を選択します。  

すると以下のように、web:warというArtifactsが追加されますので、ＯＫボタンを押して閉じます。  

今度はBuild -> Build Artifactsを選択します。  

以下のような小さなウィンドウが表示されるので、web:war -> Buildを選択します。するとwarファイルの生成が始まります。  

warファイルの生成に成功すると、画面左のプロジェクトメニューの、{プロジェクト名} -> out -> artifacts -> web_warの下にweb_war.warというwarファイルが表示されるので、生成できた事がわかります。



https://kokichiblog.com/it/800/  



## サーバセキュリティの設定(最低限)  


セキュリティについては必要なものを吟味してください。  

  
Debian環境で進めます。

Debian 

https://www.rem-system.com/debian10-first-settings/  


https://www.server-world.info/query?os=Debian_10  


http://archiva.jp/web/server-side/debian-setup.html    


CentOS前半部分  

https://qiita.com/tadatti/items/9f4911c624aafba63258  


http/https Let,s Encryptとかもいる。  


## 初期インストールされたパッケージをアップデート  

※最新版になるため注意  

```$ apt update``` 　　


```$ apt upgrade```  
   
rootログイン。パスワードが求められるのでログインする。  

```$ su```  
  
rootのパスワードを入力する。  
 

```Password:```  


rootユーザから一般ユーザへの切り替え  
```#exit```  
実行するとプロンプトが$に変わるのを確認する。  

## vim backspaceを使えるようにする。  


「.vimrc」ファイルに  

```set backspace=indent,eol,start```  


## デフォルトのvimの使いかた  

Escを押したあと、xで文字を消す。  
a、iで挿入モード  
oで改行  
ddで行の削除  

# Openjdk11 maven h2DB nginxをインストール  

今回はSpring bootに組み込まれているTomcatを使うため、リモートサーバにはTomcatをインストールしない。  

Apache、Tomcat、jdkのインストール設定  
https://qiita.com/Uejun/items/adb428cccf96f8509b8f  

https://centossrv.com/tomcat9.shtml  

https://yulii.github.io/nginx-tomcat-proxy-20110523.html  


↑Apache or NginxとTomcatの連携を行う必要がある。TomcatはAPサーバだが、Apache or Nginxを除いたTomcat単体でもWebサーバとしての機能を確保している。Tomcatだけでサーバ処理を行えばシンプルだが、Apache or Nginxと比較すれば性能は劣るため、2つを連携させることでより優位なWebサーバ構築が可能となる。(Apache Tomcat連携で調べる。または、AJP Nginx Tomcat 連携。Nginx Tomcat リバースプロキシ。)  


ApacheとNginxのメリット、デメリットは↓  


前提条件  
Debianシステムにパッケージをインストールできるようにするには、sudo特権を持つユーザーとしてログインする必要がある。  

```$ su```    


パッケージの更新  

```$ apt install ```  


インストール時にはtmpファイルで行ってあとで消せるようにする。  

```cd /tmp```  



## Openjdk11のインストール  

Openjdk11のインストールをする。  
```# apt install openjdk-11-jdk```    

システムに複数のJavaバージョンがインストールされている場合は、次のコマンドを使用してバージョンを切り替える。  

```# update-alternatives --config java```  

システムが正しいJDKを使用していることを確認する。  

```# java -version```  
 

zuluとか使わないほうがいい。    
default-jdkも誤作動あるかもなのでフルパスで指定。  


Openjdkサイト  
https://openjdk.java.net/  

## Apache mavenのインストール 

今なら3.6.3(2019/12/06現在)  

Mavenをインストール
```# apt install maven ```  

[Y/n]でYを入力し、Enter  

  

環境変数に設定されているパスを表示する。  



メモする。

```# echo JAVA_HOME```  

```# echo M2_HOME```   

```# echo MAVEN_HOME```  
  

環境変数のセットアップ    

```# vi /etc/profile.d/maven.sh```  

  
```
export JAVA_HOME=[echoしたJAVA_HOME] 
export M2_HOME=[echoしたM2_HOME]  
export MAVEN_HOME=[echoしたMAVEN_HOME]  
export PATH=${M2_HOME}/bin:${PATH}   
```  

ファイルを保存して閉じる。  
```:wq!```  

chmodコマンドを入力して、スクリプトを実行可能にする。  

```# chmod +x /etc/profile.d/maven.sh```  

sourceコマンドを使用して環境変数をロードする。

```# source /etc/profile.d/maven.sh```  


mavenインストールの確認  

```# mvn -version```  



mavenダウンロードページ  
https://maven.apache.org/download.cgi   




## h2DBのインストール  

h2DBはPureJavaのため、事前にjdkのインストールが必要です。先ほどインストールしたので大丈夫。    

```# wget http://www.h2database.com/h2-2017-03-10.zip```  

2019/12/06現在  

```# unzip h2-2019-10-14.zip```  

```# cd h2```  

webAllowOthers=trueはremote connectionを有効にするための設定  

```# echo webAllowOthers=true > ~/.h2.server.properties```  

```# java -jar bin/h2-1.4.194.jar```  

アクセス  

http://localhost:8282　にアクセスするとログイン画面がでる。  

JDBC:URLに  

サーバモードは  

```jdbc:h2:tcp://localhost/~/データベース名```  

組み込みモード(今回)  

```jdbc:h2:~/データベース名```  

と入力して接続テストを行い、successとなれば接続する。  

 
h2DBのダンプファイルをつくり、リストアする  


inteliJのデータベース->右クリック->ファイルにデータをダンプ
->  

リモートサーバ内にファイル送ってから、結局SQLをコピーしてはった。  


h2DBの設定方法  
http://yoks.blue.coocan.jp/TechNote/H2/H2_ope2.htm  


h2DB公式  
http://www.h2database.com/html/tutorial.html#console_settings 
 　　

## nginxのインストール  

```# wget http://nginx.org/keys/nginx_signing.key```   

```# apt-key add nginx_signing.key```  

viでファイルを開く。  

```#vi /etc/apt/sources.list```  

ファイルの最終行に以下2行を書き込む。(安定板)  


deb http://nginx.org/packages/debian/ stretch nginx  
deb-src http://nginx.org/packages/debian/ stretch nginx  

nginxのインストール  


```# apt -y install nginx```  

nginxのパッケージが足りないと言われることがあるので、依存関係がないようにapt install nginx をもう一度する。  


インストールの確認 -Vで詳細情報の表示  

```# nginx -V```  

自動起動の設定(インストール直後は自動起動になっているので無視してよい)。  

/etc/init.d/nginx reload  
/etc/init.d/nginx restart
とする。

systemctlはCentOS

```# sysytemctl enable nginx```  

```# systemctl is-enabled nginx```  


自動起動をやめる  

```# systemctl disable nginx ```  

```# systemctl is-enabled nginx```  

nginxにリバースプロキシの設定を追加  


nginx 80/tcp で受けて 127.0.0.1:8080/tcp へ転送
/etc/nginx/sites-enabled/reverse-proxy.conf を作成(注意: root権限が必要。sudo vi ...)
/etc/nginx/sites-enabled/reverse-proxy.conf の中身は、こんなかんじ

server {
	location / {
            proxy_pass http://localhost:8080;
        }
}

  proxy_pass実行するURL  
  
  8080はTomcat  
  
  
設定ファイルを変更したら、リロードを忘れないようにね。
	  % sudo service nginx reload
	

https://www.mk-mode.com/blog/2017/09/16/debian-9-nginx-installation-by-official-apt/  

nginx公式  
https://nginx.org/en/


# scpコマンドでデプロイ  

ssh入ってなかったのでいれる。  
```apt install ssh```  

vncを同一パソコンでひらく

scp war username@172.25.252.110:9...  
パス指定しないとhomeに設定される。  

 ホストがあるので110:9をipで探す113だった。  


# warの実行  

```/sbin/shutdown -n```

https://www.karelie.net/install-ssh-ubuntu-1804/

```java -war /home/proj/project-de-build-sitamono.war --server.port=8080 &```  

&は裏でずっと実行する。  

javaClassNotFoundExeption  
mavenをいじいじする必要があるかも  



理想はshellscript書いて自動化ができれば…  


