Welcome to the JavaDeploy wiki!  

# 制作中なので見ないでください（笑）

# JavaDeploy  


Jenkins CircleCIなどは使いません。学内Webサーバへのデプロイ手順を説明します。クラウドの話もでません。Docker Vagrantも使わない。  

ローカルの環境はOpenjdk11 Spring boot Apache maven h2DBを使用  

## warファイルを作る  

https://kokichiblog.com/it/800/  



## サーバセキュリティの設定(最低限)  


セキュリティについては必要なものを吟味してください。  

  
Debian環境で進めます。

Debian 

https://www.rem-system.com/debian10-first-settings/  


https://www.server-world.info/query?os=Debian_10  


http://archiva.jp/web/server-side/debian-setup.html    


CentOS前半部分  

https://qiita.com/tadatti/items/9f4911c624aafba63258  


http/https Let,s Encryptとかもいる。  


## 初期インストールされたパッケージをアップデート  

※最新版になるため注意  

```$ apt update``` 　　


```$ apt upgrade```  
   
rootログイン。パスワードが求められるのでログインする。  

```$ su```  
  
rootのパスワードを入力する。  
 

```Password:```  


rootユーザから一般ユーザへの切り替え  
```#exit```  
実行するとプロンプトが$に変わるのを確認する。  

## vim backspaceを使えるようにする。  


「.vimrc」ファイルに  

```set backspace=indent,eol,start```  


## デフォルトのvimの使いかた  

Escを押したあと、xで文字を消す。  
a、iで挿入モード  
oで改行  
ddで行の削除  

# Openjdk11 maven h2DB nginxをインストール  

今回はSpring bootに組み込まれているTomcatを使うため、リモートサーバにはTomcatをインストールしない。  

Apache、Tomcat、jdkのインストール設定  
https://qiita.com/Uejun/items/adb428cccf96f8509b8f  

https://centossrv.com/tomcat9.shtml  

https://yulii.github.io/nginx-tomcat-proxy-20110523.html  


↑Apache or NginxとTomcatの連携を行う必要がある。TomcatはAPサーバだが、Apache or Nginxを除いたTomcat単体でもWebサーバとしての機能を確保している。Tomcatだけでサーバ処理を行えばシンプルだが、Apache or Nginxと比較すれば性能は劣るため、2つを連携させることでより優位なWebサーバ構築が可能となる。(Apache Tomcat連携で調べる。または、AJP Nginx Tomcat 連携。Nginx Tomcat リバースプロキシ。)  


ApacheとNginxのメリット、デメリットは↓  


前提条件  
Debianシステムにパッケージをインストールできるようにするには、sudo特権を持つユーザーとしてログインする必要がある。  

```$ su```    


パッケージの更新  

```$ apt install ```  


インストール時にはtmpファイルで行ってあとで消せるようにする。  

```cd /tmp```  



## Openjdk11のインストール  

Openjdk11のインストールをする。  
```# apt install openjdk-11-jdk```    

システムに複数のJavaバージョンがインストールされている場合は、次のコマンドを使用してバージョンを切り替える。  

```# update-alternatives --config java```  

システムが正しいJDKを使用していることを確認する。  

```# java -version```  
 

zuluとか使わないほうがいい。    
default-jdkも誤作動あるかもなのでフルパスで指定。  


Openjdkサイト  
https://openjdk.java.net/  

## Apache mavenのインストール 

今なら3.6.3(2019/12/06現在)  

Mavenをインストール
```# apt install maven ```  

[Y/n]でYを入力し、Enter  

  

環境変数に設定されているパスを表示する。  



メモする。

```# echo JAVA_HOME```  

```# echo M2_HOME```   

```# echo MAVEN_HOME```  
  

環境変数のセットアップ    

```# vi /etc/profile.d/maven.sh```  

  
```
export JAVA_HOME=[echoしたJAVA_HOME] 
export M2_HOME=[echoしたM2_HOME]  
export MAVEN_HOME=[echoしたMAVEN_HOME]  
export PATH=${M2_HOME}/bin:${PATH}   
```  

ファイルを保存して閉じる。  
```:wq!```  

chmodコマンドを入力して、スクリプトを実行可能にする。  

```# chmod +x /etc/profile.d/maven.sh```  

sourceコマンドを使用して環境変数をロードする。

```# source /etc/profile.d/maven.sh```  


mavenインストールの確認  

```# mvn -version```  



mavenダウンロードページ  
https://maven.apache.org/download.cgi   




## h2DBのインストール  

h2DBはPureJavaのため、事前にjdkのインストールが必要です。先ほどインストールしたので大丈夫。    

```# wget http://www.h2database.com/h2-2017-03-10.zip```  

2019/12/06現在  

```# unzip h2-2019-10-14.zip```  

```# cd h2```  

webAllowOthers=trueはremote connectionを有効にするための設定  

```# echo webAllowOthers=true > ~/.h2.server.properties```  

```# java -jar bin/h2-1.4.194.jar```  

## アクセス  

http://localhost:8282　にアクセスするとログイン画面がでる。  

JDBC:URLに  

```jdbc:h2:tcp://localhost/~/データベース名```  

と入力して接続テストを行い、successとなれば接続する。  

 
## h2DBのダンプファイルをつくり、リストアする  

SQLを流してテーブル作成。  


h2DBの設定方法  
http://yoks.blue.coocan.jp/TechNote/H2/H2_ope2.htm  


h2DB公式  
http://www.h2database.com/html/tutorial.html#console_settings 
 　　

## nginxのインストール  

```# apt install nginx```  


インストールの確認  
```# nginx -v```

https://www.mk-mode.com/blog/2017/09/16/debian-9-nginx-installation-by-official-apt/  

https://qiita.com/lookung4/items/82c82ba8f152408e6f77  


https://shioleap.github.io/blog/Linux/Debian/install-nginx/  

https://def-4.com/nginx-php7-mariadb/  


https://github.com/hironomiu/Local-Development-Environment-Hands-On/blob/master/Step2.md  



nginx公式  
https://nginx.org/en/


# scpコマンドでデプロイ  


理想はshellscript書いて自動化ができれば…  


